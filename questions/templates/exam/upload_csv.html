<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cargar Preguntas desde CSV</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'questions/css/upload_csv.css' %}">
</head>
<body>
    <div class="upload-container">
        <a href="{% url 'examen' %}" class="back-btn">‚Üê Volver al Men√∫ Principal</a>
        
        <h1>üìÇ Cargar Preguntas desde CSV</h1>
        
        {% if validation_errors %}
            <div class="validation-errors">
                <h3>‚ö†Ô∏è Errores de Validaci√≥n Encontrados</h3>
                <p>El CSV no puede ser cargado debido a los siguientes errores:</p>
                <ul>
                    {% for error in validation_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
                <p><strong>Por favor, corrige estos errores en tu CSV y vuelve a intentarlo.</strong></p>
            </div>
        {% endif %}
        
        {% if error %}
            <div class="alert alert-error">
                <strong>Error:</strong> {{ error }}
            </div>
        {% endif %}
        
        {% if success_message %}
            <div class="alert alert-success">
                {{ success_message }}
                <br><br>
                <a href="/admin/" style="color: #155724; text-decoration: underline;">Ver en Admin</a> |
                <a href="{% url 'examen' %}" style="color: #155724; text-decoration: underline;">Ir al Men√∫ Principal</a>
            </div>
        {% endif %}
        
        {% if not validation_errors %}
            <div class="alert alert-info">
                <strong>üí° Tip:</strong> El sistema validar√° tu CSV antes de cargarlo. Si hay errores, te mostrar√° exactamente qu√© l√≠neas necesitan correcci√≥n.
            </div>
        {% endif %}

        {% if pending_confirmation %}
            <div class="alert alert-info"><strong>Se detectaron cambios.</strong> Revisa y confirma para aplicar.</div>

            <div class="validation-errors" style="background:#fff;border-color:#ddd;">
                <h3>Propuestas de cambio</h3>
                <ul>
                    {% for c in proposed_changes %}
                        <li>
                            <strong>{{ c.np }}</strong> ({{ c.question_type }}) ‚Äî 
                            {% if c.action == 'CREATE' %} üÜï Crear
                            {% elif c.action == 'UPDATE' %} ‚úèÔ∏è Actualizar
                            {% endif %}
                            {% if c.action == 'UPDATE' %}
                                <ul>
                                    {% for field, values in c.diff.items %}
                                        <li><code>{{ field }}</code>: "<em>{{ values.old }}</em>" ‚Üí "<strong>{{ values.new }}</strong>"</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </div>

            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="confirm" value="1">
                <input type="hidden" name="proposed_changes" value='{{ proposed_changes_json|escape }}'>
                <button type="submit" class="submit-btn">‚úÖ Confirmar y aplicar cambios</button>
                <a href="{% url 'upload_csv' %}" class="clear-btn" style="margin-left:10px;">Cancelar</a>
            </form>
        {% endif %}

        <div class="instructions">
            <h3>üìã Formato del Archivo CSV</h3>
            <p>Tu archivo CSV debe tener las siguientes columnas en este orden:</p>
            
            <table class="table-example">
                <thead>
                    <tr>
                        <th>NP</th>
                        <th>Question</th>
                        <th>OptionA</th>
                        <th>OptionB</th>
                        <th>OptionC</th>
                        <th>OptionD</th>
                        <th>OptionE</th>
                        <th>Answer</th>
                        <th>question_type</th>
                        <th>Image</th>
                        <th>ImageFile</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Q1</td>
                        <td>Texto de la pregunta</td>
                        <td>Opci√≥n A</td>
                        <td>Opci√≥n B</td>
                        <td>Opci√≥n C</td>
                        <td>Opci√≥n D</td>
                        <td>Opcional</td>
                        <td>Ver formatos</td>
                        <td>SINGLE/MULTI/DRAG</td>
                        <td>0/1</td>
                        <td>1.png (opcional)</td>
                    </tr>
                </tbody>
            </table>
            
            <div class="alert alert-info" style="margin-top: 15px;">
                <strong>üì∏ Manejo de Im√°genes:</strong><br>
                ‚Ä¢ <strong>Image:</strong> 1 = tiene imagen, 0 = no tiene imagen<br>
                ‚Ä¢ <strong>ImageFile (opcional):</strong> Nombre exacto del archivo (ej: "abc123.png", "topology1.jpg")<br>
                ‚Ä¢ <strong>Si no hay ImageFile:</strong> Se usar√° NP para generar el nombre (Q1 ‚Üí 1.png)<br>
                ‚Ä¢ <strong>Carpeta:</strong> Las im√°genes deben estar en la carpeta /images/ del proyecto
            </div>
            
            <div class="format-types">
                <div class="format-type">
                    <h4>üìò SINGLE (Selecci√≥n √önica)</h4>
                    <p><strong>question_type:</strong> <code>SINGLE</code></p>
                    <p><strong>Answer:</strong> Una letra (ej: <code>A</code>, <code>B</code>, <code>C</code>)</p>
                </div>
                
                <div class="format-type">
                    <h4>‚òëÔ∏è MULTI (Selecci√≥n M√∫ltiple)</h4>
                    <p><strong>question_type:</strong> <code>MULTI</code></p>
                    <p><strong>Answer:</strong> Letras separadas por gui√≥n (ej: <code>A-C-D</code>)</p>
                </div>
                
                <div class="format-type">
                    <h4>üéØ DRAG (Arrastrar y Soltar)</h4>
                    <p><strong>question_type:</strong> <code>DRAG</code></p>
                    <p><strong>OptionA:</strong> Array JSON de opciones</p>
                    <p><strong>Answer:</strong> Array JSON de respuestas correctas</p>
                </div>
            </div>
        </div>
        
        <form method="POST" enctype="multipart/form-data" class="upload-form" id="uploadForm">
            {% csrf_token %}
            
            <div class="file-input-wrapper">
                <input type="file" name="csv_file" accept=".csv" class="file-input" id="csvFile" required>
                <button type="button" class="file-input-button">
                    üìÅ Seleccionar Archivo CSV
                </button>
            </div>
            
            <div class="file-name" id="fileName">
                Ning√∫n archivo seleccionado
            </div>
            
            <br>
            <button type="submit" class="submit-btn" id="submitBtn" disabled>
                üìù Validar y Cargar CSV
            </button>
        </form>
        
        <div style="text-align: center; margin-top: 30px;">
            <a href="{% url 'examen' %}" style="color: #007bff; text-decoration: none;">
                ‚Üê Volver al Men√∫ Principal
            </a>
        </div>
    </div>

    <script src="{% static 'questions/js/upload_csv.js' %}"></script>
</body>
</html>